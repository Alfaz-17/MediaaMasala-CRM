# Database Design Document (Phase 1) - RBAC Enhanced

## Project

**CRM System – Phase 1 (Leads & Tasks Priority with Flexible RBAC)**

**Database:** PostgreSQL
**Scope:** Phase 1 with dynamic role-based access control system

---

## 1. Purpose of This Document

This document defines the **database schema** for Phase 1 of the CRM system with a **flexible Role-Based Access Control (RBAC)** architecture.

It acts as the **single source of truth** for:

* Tables and columns with normalized relationships
* Role and permission management
* Dynamic permission assignment
* Data ownership and access control

This schema enables **runtime permission customization without code changes**.

---

## 2. Design Principles

* **Normalized database design** (no VARCHAR-based roles/departments)
* **Flexible RBAC** - roles and permissions managed in database
* Support for dynamic permission assignment
* Auto-generated employee IDs for HR tracking
* Clear separation between authentication and employee profile
* Support for permission scopes (own / team / department / all)
* Phase‑2‑ready (projects, notifications, reports)

---

## 3. Entity Relationship Overview (High Level)

```
DEPARTMENTS (master data)
     │
     ├──→ USERS (login) ──→ role_id ──→ ROLES
     │         │                          │
     │         1:1                        │
     │         ↓                          │
     └──→ EMPLOYEES (profile)             │
              │                          │
              │                          ↓
              │                    ROLE_PERMISSIONS
              │                          ↓
              │                    PERMISSIONS (master)
              │
              ├── 1:* ──→ LEADS
              │
              └── 1:* ──→ TASKS
```

---

## 4. Tables Overview

| Table Name              | Purpose                                  |
| ----------------------- | ---------------------------------------- |
| departments             | Department master data                   |
| roles                   | Role definitions                         |
| permissions             | Permission master data                   |
| role_permissions        | Many-to-many role-permission mapping     |
| users                   | Authentication & login                   |
| employees               | Employee profile & hierarchy             |
| leads                   | Sales leads management                   |
| tasks                   | Task tracking & assignments              |
| lead_assignment_logs    | Lead assignment audit trail              |

---

## 5. Core RBAC Tables

---

### 5.1 departments

**Purpose:** Master table for organizational departments.

```sql
CREATE TABLE departments (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  code VARCHAR(20) UNIQUE NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Sample Data:**
```sql
INSERT INTO departments (name, code, description) VALUES
  ('Sales', 'SALES', 'Sales and business development'),
  ('Development', 'DEV', 'Software development team'),
  ('Product', 'PROD', 'Product management'),
  ('HR', 'HR', 'Human resources');
```

**Notes:**
* Admin can add/edit departments via UI
* `code` used for consistent referencing
* Soft delete using `is_active`

---

### 5.2 roles

**Purpose:** Master table for system roles.

```sql
CREATE TABLE roles (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  code VARCHAR(20) UNIQUE NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Sample Data:**
```sql
INSERT INTO roles (name, code, description) VALUES
  ('Admin', 'ADMIN', 'Full system access'),
  ('Manager', 'MANAGER', 'Team management access'),
  ('Employee', 'EMPLOYEE', 'Individual contributor access');
```

**Notes:**
* Admin can create custom roles via UI
* No hardcoded role checks in application code
* `code` used for system-level role identification

---

### 5.3 permissions

**Purpose:** Master table defining all available permissions in the system.

```sql
CREATE TABLE permissions (
  id SERIAL PRIMARY KEY,
  module VARCHAR(50) NOT NULL,
  action VARCHAR(50) NOT NULL,
  scope_type VARCHAR(20) NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (module, action, scope_type)
);
```

**Module Values:** leads, tasks, projects, employees, reports, settings

**Action Values:** view, create, edit, delete, assign, export

**Scope Type Values:** own, team, department, all

**Sample Data:**
```sql
INSERT INTO permissions (module, action, scope_type, description) VALUES
  -- Leads permissions
  ('leads', 'view', 'own', 'View own leads'),
  ('leads', 'view', 'team', 'View team leads'),
  ('leads', 'view', 'department', 'View department leads'),
  ('leads', 'view', 'all', 'View all leads'),
  ('leads', 'create', 'all', 'Create new leads'),
  ('leads', 'edit', 'own', 'Edit own leads'),
  ('leads', 'edit', 'team', 'Edit team leads'),
  ('leads', 'edit', 'all', 'Edit all leads'),
  ('leads', 'delete', 'all', 'Delete leads'),
  ('leads', 'assign', 'team', 'Assign leads to team'),
  ('leads', 'assign', 'all', 'Assign leads to anyone'),
  
  -- Tasks permissions
  ('tasks', 'view', 'own', 'View own tasks'),
  ('tasks', 'view', 'team', 'View team tasks'),
  ('tasks', 'view', 'all', 'View all tasks'),
  ('tasks', 'create', 'all', 'Create new tasks'),
  ('tasks', 'edit', 'own', 'Edit own tasks'),
  ('tasks', 'edit', 'team', 'Edit team tasks'),
  ('tasks', 'edit', 'all', 'Edit all tasks'),
  ('tasks', 'delete', 'all', 'Delete tasks'),
  
  -- Employee permissions
  ('employees', 'view', 'team', 'View team members'),
  ('employees', 'view', 'department', 'View department members'),
  ('employees', 'view', 'all', 'View all employees'),
  ('employees', 'create', 'all', 'Create new employees'),
  ('employees', 'edit', 'all', 'Edit employee profiles'),
  ('employees', 'delete', 'all', 'Delete employees');
```

**Notes:**
* Permissions are seeded during system setup
* New modules/actions can be added as system grows
* Permissions define granular access control

---

### 5.4 role_permissions

**Purpose:** Maps which permissions are assigned to which roles (many-to-many relationship).

```sql
CREATE TABLE role_permissions (
  id SERIAL PRIMARY KEY,
  role_id INT NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
  permission_id INT NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (role_id, permission_id)
);
```

**Sample Data (Admin Role - Full Access):**
```sql
-- Assign all permissions to Admin role (role_id = 1)
INSERT INTO role_permissions (role_id, permission_id)
  SELECT 1, id FROM permissions;
```

**Sample Data (Manager Role - Team Scope):**
```sql
-- Assign team-level permissions to Manager role (role_id = 2)
INSERT INTO role_permissions (role_id, permission_id)
  SELECT 2, id FROM permissions 
  WHERE scope_type IN ('own', 'team') OR action = 'create';
```

**Sample Data (Employee Role - Own Scope):**
```sql
-- Assign own-level permissions to Employee role (role_id = 3)
INSERT INTO role_permissions (role_id, permission_id)
  SELECT 3, id FROM permissions 
  WHERE scope_type = 'own' OR action = 'create';
```

**Notes:**
* Admin UI allows adding/removing permissions from roles
* Changes take effect on next user login
* Multiple roles can share same permissions

---

## 6. User & Employee Tables

---

### 6.1 users

**Purpose:** Handles authentication and login credentials.

```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  role_id INT NOT NULL REFERENCES roles(id),
  department_id INT NOT NULL REFERENCES departments(id),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Breaking Changes from Previous Version:**
* ❌ Removed: `role VARCHAR(50)` 
* ❌ Removed: `department VARCHAR(50)`
* ✅ Added: `role_id INT` (foreign key to roles table)
* ✅ Added: `department_id INT` (foreign key to departments table)

**Notes:**
* `role_id` determines user permissions via role_permissions
* `department_id` links to department for scoped access
* One user = one employee

---

### 6.2 employees

**Purpose:** Stores employee profile and reporting hierarchy.

```sql
CREATE TABLE employees (
  id SERIAL PRIMARY KEY,
  emp_id VARCHAR(20) UNIQUE NOT NULL,
  user_id INT UNIQUE REFERENCES users(id) ON DELETE CASCADE,
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  phone VARCHAR(20),
  department_id INT NOT NULL REFERENCES departments(id),
  role_id INT NOT NULL REFERENCES roles(id),
  manager_id INT REFERENCES employees(id) CHECK (manager_id <> id),
  joining_date DATE,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Breaking Changes from Previous Version:**
* ✅ Added: `emp_id VARCHAR(20)` (auto-generated, format: EMP001, EMP002...)
* ❌ Removed: `department VARCHAR(50)`
* ❌ Removed: `role VARCHAR(50)`
* ✅ Added: `department_id INT` (foreign key to departments table)
* ✅ Added: `role_id INT` (foreign key to roles table)

**Employee ID Generation:**
* Format: `EMP001`, `EMP002`, `EMP003`...
* Auto-generated on employee creation
* Read-only, cannot be edited
* Unique constraint enforced

**Notes:**
* `emp_id` for HR tracking and employee reference
* `manager_id` enables team hierarchy for permission scopes
* `role_id` determines permissions
* Soft delete using `is_active`

---

## 7. Business Data Tables

---

### 7.1 leads

**Purpose:** Stores all sales leads.

```sql
-- Create ENUM type for lead status
CREATE TYPE lead_status AS ENUM ('New', 'Contacted', 'Qualified', 'Converted', 'Lost');

-- Create ENUM type for lead source
CREATE TYPE lead_source AS ENUM ('Website', 'Referral', 'Cold Call', 'Email');

CREATE TABLE leads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  phone VARCHAR(20),
  company VARCHAR(255),
  source lead_source NOT NULL,
  status lead_status NOT NULL DEFAULT 'New',
  owner_id INT REFERENCES employees(id),
  department_id INT NOT NULL REFERENCES departments(id),
  notes TEXT,
  last_activity_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Breaking Changes from Previous Version:**
* ❌ Removed: `department VARCHAR(50)`
* ✅ Added: `department_id INT` (foreign key to departments table)

**Allowed Values:**
* `source`: Website, Referral, Cold Call, Email
* `status`: New, Contacted, Qualified, Converted, Lost

**Notes:**
* `owner_id` determines data ownership for permission scopes
* `department_id` for department-wide access control

---

### 7.2 tasks

**Purpose:** Tracks tasks assigned to employees.

```sql
-- Note: project_id and product_id reference tables to be created in Phase 2
CREATE TABLE tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  assignee_id INT REFERENCES employees(id),
  creator_id INT REFERENCES employees(id),
  due_date TIMESTAMP NOT NULL,
  priority VARCHAR(20) NOT NULL,
  status VARCHAR(50) NOT NULL,
  related_to_lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,
  project_id INT DEFAULT NULL,
  product_id INT DEFAULT NULL,
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Allowed Values:**
* `priority`: High, Medium, Low
* `status`: Pending, In Progress, Completed, Cancelled

**Notes:**
* Tasks can optionally link to leads
* `project_id` and `product_id` are Phase 2 fields - will reference projects and products tables
* Foreign key constraints will be added in Phase 2 migration
* Used heavily in dashboard metrics
* Permission scope determined by assignee/creator relationship

---

### 7.3 lead_assignment_logs

**Purpose:** Tracks the complete history of lead assignments for audit trail and analytics.

```sql
CREATE TABLE lead_assignment_logs (
  id SERIAL PRIMARY KEY,
  lead_id UUID NOT NULL REFERENCES leads(id) ON DELETE CASCADE,
  assignee_id INT NOT NULL REFERENCES employees(id),
  assigned_to_id INT NOT NULL REFERENCES employees(id),
  date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  lead_status lead_status NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Purpose of Fields:**
* `lead_id`: The lead that was assigned
* `assignee_id`: The employee who performed the assignment (manager/admin)
* `assigned_to_id`: The employee to whom the lead was assigned
* `date`: When the assignment occurred
* `lead_status`: The status of the lead at the time of assignment

**Notes:**
* Creates immutable audit trail for lead assignments
* Enables analytics on assignment patterns
* Helps identify reassignment frequency
* Used for performance tracking

---

## 8. Relationships Summary

| From                      | To                       | Type      | Constraint    |
| ------------------------- | ------------------------ | --------- | ------------- |
| departments.id            | users.department_id      | 1‑to‑many | FK, NOT NULL  |
| departments.id            | employees.department_id  | 1‑to‑many | FK, NOT NULL  |
| departments.id            | leads.department_id      | 1‑to‑many | FK, NOT NULL  |
| roles.id                  | users.role_id            | 1‑to‑many | FK, NOT NULL  |
| roles.id                  | employees.role_id        | 1‑to‑many | FK, NOT NULL  |
| roles.id                  | role_permissions.role_id | 1‑to‑many | FK, CASCADE   |
| permissions.id            | role_permissions.perm_id | 1‑to‑many | FK, CASCADE   |
| users.id                  | employees.user_id        | 1‑to‑1    | FK, UNIQUE    |
| employees.id              | employees.manager_id     | self‑ref  | FK, nullable  |
| employees.id              | leads.owner_id           | 1‑to‑many | FK, nullable  |
| employees.id              | tasks.assignee_id        | 1‑to‑many | FK, nullable  |
| employees.id              | tasks.creator_id         | 1‑to‑many | FK, nullable  |
| leads.id                  | tasks.related_to_lead_id | 1‑to‑many | FK, nullable  |
| leads.id                  | lead_assignment_logs.lead_id | 1‑to‑many | FK, CASCADE |
| employees.id              | lead_assignment_logs.assignee_id | 1‑to‑many | FK, NOT NULL |
| employees.id              | lead_assignment_logs.assigned_to_id | 1‑to‑many | FK, NOT NULL |

---

## 9. Indexing Recommendations

```sql
-- RBAC indexes
CREATE INDEX idx_users_role ON users(role_id);
CREATE INDEX idx_users_department ON users(department_id);
CREATE INDEX idx_employees_role ON employees(role_id);
CREATE INDEX idx_employees_department ON employees(department_id);
CREATE INDEX idx_employees_emp_id ON employees(emp_id);
CREATE INDEX idx_role_permissions_role ON role_permissions(role_id);
CREATE INDEX idx_permissions_module ON permissions(module);

-- Business data indexes
CREATE INDEX idx_leads_owner ON leads(owner_id);
CREATE INDEX idx_leads_department ON leads(department_id);
CREATE INDEX idx_tasks_assignee ON tasks(assignee_id);
CREATE INDEX idx_tasks_creator ON tasks(creator_id);
CREATE INDEX idx_tasks_due_date ON tasks(due_date);
CREATE INDEX idx_tasks_project ON tasks(project_id);
CREATE INDEX idx_tasks_product ON tasks(product_id);

-- Lead assignment logs indexes
CREATE INDEX idx_lead_assignment_logs_lead ON lead_assignment_logs(lead_id);
CREATE INDEX idx_lead_assignment_logs_assignee ON lead_assignment_logs(assignee_id);
CREATE INDEX idx_lead_assignment_logs_assigned_to ON lead_assignment_logs(assigned_to_id);
CREATE INDEX idx_lead_assignment_logs_date ON lead_assignment_logs(date);
```

---

## 10. Employee ID Sequence

**Purpose:** Generate sequential employee IDs.

```sql
CREATE SEQUENCE emp_id_seq START 1;

-- Function to generate next employee ID
CREATE OR REPLACE FUNCTION generate_emp_id()
RETURNS VARCHAR(20) AS $$
DECLARE
  next_num INT;
  emp_id VARCHAR(20);
BEGIN
  next_num := nextval('emp_id_seq');
  emp_id := 'EMP' || LPAD(next_num::TEXT, 3, '0');
  RETURN emp_id;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-generate emp_id
CREATE OR REPLACE FUNCTION set_emp_id()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.emp_id IS NULL OR NEW.emp_id = '' THEN
    NEW.emp_id := generate_emp_id();
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_set_emp_id
  BEFORE INSERT ON employees
  FOR EACH ROW
  EXECUTE FUNCTION set_emp_id();
```

---

## 11. Migration Guide (From Old Schema)

**Step 1:** Create new tables (departments, roles, permissions, role_permissions)

**Step 2:** Migrate existing data
```sql
-- Create departments from unique values
INSERT INTO departments (name, code)
  SELECT DISTINCT department, UPPER(department) 
  FROM users;

-- Create roles from unique values
INSERT INTO roles (name, code)
  SELECT DISTINCT role, UPPER(role)
  FROM users;

-- Update users table
ALTER TABLE users ADD COLUMN role_id INT;
ALTER TABLE users ADD COLUMN department_id INT;

UPDATE users u
SET role_id = r.id
FROM roles r
WHERE u.role = r.name;

UPDATE users u
SET department_id = d.id
FROM departments d
WHERE u.department = d.name;

-- Make foreign keys NOT NULL after migration
ALTER TABLE users ALTER COLUMN role_id SET NOT NULL;
ALTER TABLE users ALTER COLUMN department_id SET NOT NULL;

-- Drop old VARCHAR columns
ALTER TABLE users DROP COLUMN role;
ALTER TABLE users DROP COLUMN department;
```

**Step 3:** Seed permissions and role_permissions as shown in sections 5.3 and 5.4

**Step 4:** Update employees table similarly

---

## 12. Phase 2 Compatibility Notes

This schema is designed to support:

* Custom role creation via Admin UI
* Dynamic permission assignment
* Permission inheritance (future)
* Project-based permissions
* Audit logs on permission changes
* Reports & analytics filtered by permissions

No breaking changes expected for Phase 2.

---

## 13. Status

✅ **Approved for Phase 1 Development with RBAC**

This document replaces the previous VARCHAR-based permission system with a flexible, normalized RBAC architecture.
